<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="乌鸦喝水动画演示 - 通过添加石子使水位上升" />
    <title>乌鸦喝水 - 打破知识付费墙</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.14.2/build/matter.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
      /* 保持原有样式不变 */
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: "Arial", "Microsoft YaHei", sans-serif;
        background-color: #f5f5f5;
        margin: 0;
        padding: 20px;
        min-height: 100vh;
        box-sizing: border-box;
      }
      button {
        margin: 10px;
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 4px;
        transition: background-color 0.3s;
      }
      button:hover {
        background-color: #45a049;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .container {
        max-width: 800px;
        width: 100%;
        text-align: center;
      }
      .instructions {
        margin: 20px 0;
        color: #666;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>乌鸦喝水</h1>
      <p class="instructions">点击"添加石子"按钮，观察水位变化</p>
      <div>
        <button id="dropStone">添加石子</button>
        <button id="reset">重置</button>
      </div>
      <svg width="100%" height="400" viewBox="0 0 400 300" preserveAspectRatio="xMidYMid meet" xmlns="http://www.w3.org/2000/svg">
        <!-- SVG 水桶 -->
        <g id="bucket">
          <rect x="150" y="150" width="100" height="100" fill="#E8E8E8" stroke="#333" stroke-width="2" rx="2" />
          <path d="M150,150 Q200,140 250,150" fill="none" stroke="#333" stroke-width="2" />
          <path d="M145,160 Q135,180 145,200" fill="none" stroke="#333" stroke-width="2" />
          <path d="M255,160 Q265,180 255,200" fill="none" stroke="#333" stroke-width="2" />
          <line x1="150" y1="170" x2="250" y2="170" stroke="#CCC" stroke-width="1" />
          <line x1="150" y1="190" x2="250" y2="190" stroke="#CCC" stroke-width="1" />
          <line x1="150" y1="210" x2="250" y2="210" stroke="#CCC" stroke-width="1" />
          <line x1="150" y1="230" x2="250" y2="230" stroke="#CCC" stroke-width="1" />
          <text x="200" y="200" font-size="16" font-family="Arial" text-anchor="middle" fill="black" font-weight="bold">知识付费墙</text>
        </g>

        <!-- 初始水位 -->
        <rect id="water" x="150" y="240" width="100" height="10" fill="#A3DFFA" opacity="0.8">
          <animate id="waterRise" attributeName="y" dur="0.5s" fill="freeze" begin="indefinite" />
          <animate id="waterHeight" attributeName="height" dur="0.5s" fill="freeze" begin="indefinite" />
        </rect>

        <!-- 水面波纹效果 - 持续波动 -->
        <path id="waterWave" d="M150,240 Q175,238 200,240 Q225,242 250,240" stroke="#7AC5E4" fill="none" opacity="0.7" stroke-width="1.5">
          <animate
            id="waveAnim"
            attributeName="d"
            values="
            M150,240 Q175,238 200,240 Q225,242 250,240;
            M150,240 Q175,235 200,240 Q225,245 250,240;
            M150,240 Q175,238 200,240 Q225,242 250,240;
            M150,240 Q175,242 200,240 Q225,238 250,240;
            M150,240 Q175,238 200,240 Q225,242 250,240"
            dur="3s"
            repeatCount="indefinite"
          />
          <animate id="waveAmplify" attributeName="stroke-width" values="1.5;3;1.5" dur="0.5s" begin="indefinite" fill="freeze" />
        </path>

        <!-- 石子组 -->
        <g id="stones"></g>

        <!-- 乌鸦 -->
        <g id="crow">
          <ellipse cx="50" cy="50" rx="25" ry="12" fill="#1C2526" />
          <circle cx="75" cy="45" r="8" fill="#1C2526">
            <animateTransform attributeName="transform" type="rotate" values="0 75 45; 5 75 45; -5 75 45; 0 75 45" dur="2s" repeatCount="indefinite" />
          </circle>
          <polygon points="83,45 90,50 83,55" fill="#F5C518">
            <animateTransform attributeName="transform" type="rotate" values="0 83 50; 5 83 50; -5 83 50; 0 83 50" dur="1.5s" repeatCount="indefinite" />
          </polygon>
          <circle id="birdStone" cx="88" cy="50" r="3" fill="gray" />
          <path d="M45,50 Q30,60 35,70 Q45,75 55,50" fill="#1C2526">
            <animateTransform attributeName="transform" type="rotate" values="0 50 50; -20 50 50; 0 50 50; 10 50 50; 0 50 50" dur="0.6s" repeatCount="indefinite" keyTimes="0;0.3;0.5;0.8;1" />
          </path>
          <path d="M45,50 Q30,45 35,40 Q45,35 55,50" fill="#1C2526">
            <animateTransform attributeName="transform" type="rotate" values="0 50 50; 10 50 50; 0 50 50; -20 50 50; 0 50 50" dur="0.6s" repeatCount="indefinite" keyTimes="0;0.3;0.5;0.8;1" />
          </path>
          <path d="M25,50 Q35,65 45,50" fill="#1C2526">
            <animateTransform attributeName="transform" type="rotate" values="0 25 50; 5 25 50; -5 25 50; 0 25 50" dur="2s" repeatCount="indefinite" />
          </path>
          <circle cx="77" cy="43" r="2" fill="white">
            <animate id="eyeBlink" attributeName="r" values="2;0.5;2" dur="0.3s" begin="indefinite" repeatCount="1" />
          </circle>
          <circle cx="77" cy="43" r="0.8" fill="black" />
          <g id="legs">
            <line x1="45" y1="60" x2="45" y2="75" stroke="#1C2526" stroke-width="1.5">
              <animateTransform attributeName="transform" type="rotate" values="0 45 60; 5 45 60; -5 45 60; 0 45 60" dur="1s" repeatCount="indefinite" />
            </line>
            <line x1="45" y1="75" x2="42" y2="80" stroke="#1C2526" stroke-width="1" />
            <line x1="45" y1="75" x2="45" y2="80" stroke="#1C2526" stroke-width="1" />
            <line x1="45" y1="75" x2="48" y2="80" stroke="#1C2526" stroke-width="1" />
            <line x1="55" y1="60" x2="55" y2="75" stroke="#1C2526" stroke-width="1.5">
              <animateTransform attributeName="transform" type="rotate" values="0 55 60; -5 55 60; 5 55 60; 0 55 60" dur="1.2s" repeatCount="indefinite" />
            </line>
            <line x1="55" y1="75" x2="52" y2="80" stroke="#1C2526" stroke-width="1" />
            <line x1="55" y1="75" x2="55" y2="80" stroke="#1C2526" stroke-width="1" />
            <line x1="55" y1="75" x2="58" y2="80" stroke="#1C2526" stroke-width="1" />
          </g>
          <animateTransform id="crowMove" attributeName="transform" type="translate" values="0,0; 30,10; 60,20; 90,30; 100,40" keyTimes="0;0.3;0.6;0.9;1" dur="1.2s" begin="indefinite" fill="freeze" />
          <animateTransform id="crowDrink" attributeName="transform" type="rotate" values="0 75 45; -10 75 45; -20 75 45; -15 75 45; -20 75 45" keyTimes="0;0.3;0.6;0.8;1" dur="0.8s" begin="indefinite" fill="freeze" />
          <animateTransform id="crowReturn" attributeName="transform" type="translate" values="100,40; 70,30; 40,20; 10,10; 0,0" keyTimes="0;0.3;0.6;0.9;1" dur="1.2s" begin="indefinite" fill="freeze" />
        </g>
      </svg>
      <audio id="stoneSplash" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>
      <audio id="crowCaw" src="https://www.soundjay.com/nature/crow-01.mp3"></audio>
    </div>
    <script>
      // 初始化物理引擎
      const Engine = Matter.Engine,
        World = Matter.World,
        Bodies = Matter.Bodies,
        Composite = Matter.Composite;

      // 连接Socket.io服务器
      const socket = io("http://localhost:3000");
      const remoteStoneSVGElements = new Map();

      const engine = Engine.create({
        enableSleeping: true,
      });
      const world = engine.world; // 明确定义world变量
      engine.world.gravity.y = 0.5;
      engine.world.scale = 0.8;

      // 初始化物理世界
      const ground = Bodies.rectangle(200, 252, 100, 5, { isStatic: true });
      const leftWall = Bodies.rectangle(150, 200, 10, 100, { isStatic: true });
      const rightWall = Bodies.rectangle(250, 200, 10, 100, { isStatic: true });
      World.add(world, [ground, leftWall, rightWall]);

      // 初始化变量
      const stonesGroup = document.getElementById("stones");
      const crow = document.getElementById("crow");
      const water = document.getElementById("water");
      const waterRise = document.getElementById("waterRise");
      const waterHeightAnim = document.getElementById("waterHeight");
      const crowMove = document.getElementById("crowMove");
      const crowDrink = document.getElementById("crowDrink");
      const crowReturn = document.getElementById("crowReturn");
      const stoneSplash = document.getElementById("stoneSplash");
      const crowCaw = document.getElementById("crowCaw");
      const birdStone = document.getElementById("birdStone");
      const eyeBlink = document.getElementById("eyeBlink");

      let waterLevel = 240;
      let waterHeight = 10;
      let stoneCount = 0;
      const maxStones = 50;
      let isAnimationInProgress = false;
      let stones = [];

      // 监听服务器事件
      socket.on("stoneAdded", (data) => {
        if (!document.querySelector(`circle[data-id="${data.id}"]`)) {
          const svgStone = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          svgStone.setAttribute("data-id", data.id);
          svgStone.setAttribute("cx", data.x);
          svgStone.setAttribute("cy", data.y);
          svgStone.setAttribute("r", 3);
          svgStone.setAttribute("fill", "gray");
          stonesGroup.appendChild(svgStone);
          remoteStoneSVGElements.set(data.id, svgStone);
          stoneCount++;
        }
      });

      socket.on("stoneUpdated", (data) => {
        const svgStone = document.querySelector(`circle[data-id="${data.id}"]`);
        if (svgStone) {
          svgStone.setAttribute("cx", data.x);
          svgStone.setAttribute("cy", data.y);
        }
      });

      socket.on("stoneRemoved", (id) => {
        const svgStone = document.querySelector(`circle[data-id="${id}"]`);
        if (svgStone) {
          stonesGroup.removeChild(svgStone);
          remoteStoneSVGElements.delete(id);
          stoneCount--;
        }
      });

      // 页面加载时请求初始状态
      socket.emit("requestInit");

      // 初始化和水位同步逻辑
      socket.on("init", (data) => {
        // 重置现有远程石子
        remoteStoneSVGElements.forEach((svg, id) => {
          stonesGroup.removeChild(svg);
          remoteStoneSVGElements.delete(id);
        });

        // 初始化远程石子
        data.stones.forEach((stone) => {
          if (!document.querySelector(`circle[data-id="${stone.id}"]`)) {
            const svgStone = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            svgStone.setAttribute("data-id", stone.id);
            svgStone.setAttribute("cx", stone.x);
            svgStone.setAttribute("cy", stone.y);
            svgStone.setAttribute("r", 5);
            svgStone.setAttribute("fill", "gray");
            stonesGroup.appendChild(svgStone);
            remoteStoneSVGElements.set(stone.id, svgStone);
            // 为远程石子创建物理体并添加到物理世界
            const physicsStone = Bodies.circle(stone.x, stone.y, 5, {
              restitution: 0.3,
              friction: 0.5,
              density: 0.01,
              isStatic: false,
            });
            physicsStone.id = stone.id;
            World.add(world, physicsStone);
            svgStone.physicsBody = physicsStone;
          }
        });
        stoneCount = data.stones.length;

        // 同步初始水位并重置波纹
        if (data.waterLevel !== undefined && data.waterHeight !== undefined) {
          waterLevel = data.waterLevel;
          waterHeight = data.waterHeight;
          water.setAttribute("y", waterLevel);
          water.setAttribute("height", waterHeight);
          // 重置波纹动画到初始状态
          document.getElementById("waterWave").setAttribute("d", "M150,240 Q175,238 200,240 Q225,242 250,240");
        }
      });

      // 水位同步更新
      socket.on("waterUpdated", (data) => {
        if (!isAnimationInProgress) {
          waterLevel = data.level;
          waterHeight = data.height;
          water.setAttribute("y", waterLevel);
          water.setAttribute("height", waterHeight);
          // 重置波纹动画到初始状态
          document.getElementById("waterWave").setAttribute("d", "M150,240 Q175,238 200,240 Q225,242 250,240");
        }
      });

      // 错误处理
      socket.on("connect_error", (err) => {
        console.error("Socket连接错误:", err);
      });

      // 修改dropStone事件处理，添加完整同步逻辑
      document.getElementById("dropStone").addEventListener("click", () => {
        if (stoneCount >= maxStones || isAnimationInProgress) return;

        isAnimationInProgress = true;
        const dropBtn = document.getElementById("dropStone");
        const resetBtn = document.getElementById("reset");
        dropBtn.disabled = true;
        resetBtn.disabled = true;

        // 触发眨眼动画
        eyeBlink.beginElement();

        // 乌鸦飞向水桶
        crowMove.beginElement();

        crowMove.addEventListener(
          "endEvent",
          () => {
            // 隐藏乌鸦嘴边的石子
            birdStone.setAttribute("opacity", "0");
            eyeBlink.beginElement();

            // 创建本地石子
            const stoneId = Date.now().toString();
            const stone = Bodies.circle(180, 100, 5, {
              restitution: 0.3,
              friction: 0.5,
              density: 0.01,
            });
            stone.id = stoneId;
            World.add(world, stone);

            const svgStone = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            svgStone.setAttribute("data-id", stoneId);
            svgStone.setAttribute("cx", 180);
            svgStone.setAttribute("cy", 100);
            svgStone.setAttribute("r", 5);
            svgStone.setAttribute("fill", "gray");
            stonesGroup.appendChild(svgStone);

            stone.svgElement = svgStone;
            stoneCount++;

            // 通知服务器添加石子
            socket.emit("addStone", {
              id: stoneId,
              x: 180,
              y: 100,
            });

            // 检查石子是否停止
            let checkStoneInterval = setInterval(() => {
              if (stone.speed < 0.14) {
                clearInterval(checkStoneInterval);

                // 更新水位
                waterLevel -= 0.5;
                waterHeight += 0.5;
                if (waterLevel < 150) waterLevel = 150;
                if (waterHeight > 100) waterHeight = 100;

                waterRise.setAttribute("from", water.getAttribute("y"));
                waterRise.setAttribute("to", waterLevel);
                waterHeightAnim.setAttribute("from", water.getAttribute("height"));
                waterHeightAnim.setAttribute("to", waterHeight);
                waterRise.beginElement();
                waterHeightAnim.beginElement();
                water.setAttribute("y", waterLevel);
                water.setAttribute("height", waterHeight);
                stoneSplash.play();
                // 触发水波幅度扩大效果
                document.getElementById("waveAmplify").beginElement();

                // 通知服务器更新水位
                socket.emit("updateWater", {
                  level: waterLevel,
                  height: waterHeight,
                });

                // 乌鸦返回
                setTimeout(() => {
                  eyeBlink.beginElement();
                  crowReturn.beginElement();
                  crowReturn.addEventListener(
                    "endEvent",
                    () => {
                      birdStone.setAttribute("opacity", "1");
                      isAnimationInProgress = false;
                      dropBtn.disabled = false;
                      resetBtn.disabled = false;
                    },
                    { once: true }
                  );
                }, 1500);
              }
            }, 100);
          },
          { once: true }
        );
      });

      // 动画循环
      let lastTime = 0;
      const fps = 60;
      const interval = 1000 / fps;

      function run(currentTime) {
        if (currentTime - lastTime > interval) {
          Engine.update(engine, interval);
          world.bodies.forEach((body) => {
            if (body.svgElement) {
              body.svgElement.setAttribute("cx", body.position.x);
              body.svgElement.setAttribute("cy", body.position.y);

              // 同步本地石子位置到服务器
              if (body.id && !isAnimationInProgress) {
                socket.emit("updateStone", {
                  id: body.id,
                  x: body.position.x,
                  y: body.position.y,
                });
              }
            }
          });
          lastTime = currentTime;
        }
        requestAnimationFrame(run);
      }
      requestAnimationFrame(run);

      // 重置功能
      document.getElementById("reset").addEventListener("click", () => {
        Composite.clear(world, false);
        while (stonesGroup.firstChild) {
          stonesGroup.removeChild(stonesGroup.firstChild);
        }
        stones = [];
        waterLevel = 240;
        waterHeight = 10;
        water.setAttribute("y", waterLevel);
        water.setAttribute("height", waterHeight);
        crow.setAttribute("transform", "");
        birdStone.setAttribute("opacity", "1");
        stoneCount = 0;
        isAnimationInProgress = false;
      });
    </script>
  </body>
</html>
