<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>打破知识付费墙</title>
    <script src="https://cdn.jsdelivr.net/npm/matter-js@0.14.2/build/matter.min.js"></script>
    <style>
      body {
        display: flex;
        flex-direction: column;
        align-items: center;
        font-family: Arial, sans-serif;
      }
      button {
        margin: 10px;
        padding: 8px 16px;
        font-size: 16px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div>
      <button id="dropStone">点击落石</button>
      <button id="reset">重置</button>
    </div>
    <svg width="400" height="300" xmlns="http://www.w3.org/2000/svg">
      <!-- SVG 水桶 - 改进版 -->
      <g id="bucket">
        <!-- 桶身 -->
        <rect x="150" y="150" width="100" height="100" fill="#E8E8E8" stroke="#333" stroke-width="2" rx="2" />
        <!-- 桶边缘 -->
        <path d="M150,150 Q200,140 250,150" fill="none" stroke="#333" stroke-width="2" />
        <!-- 桶把手 -->
        <path d="M145,160 Q135,180 145,200" fill="none" stroke="#333" stroke-width="2" />
        <path d="M255,160 Q265,180 255,200" fill="none" stroke="#333" stroke-width="2" />
        <!-- 桶纹理 -->
        <line x1="150" y1="170" x2="250" y2="170" stroke="#CCC" stroke-width="1" />
        <line x1="150" y1="190" x2="250" y2="190" stroke="#CCC" stroke-width="1" />
        <line x1="150" y1="210" x2="250" y2="210" stroke="#CCC" stroke-width="1" />
        <line x1="150" y1="230" x2="250" y2="230" stroke="#CCC" stroke-width="1" />
        <!-- 水桶上的文字 -->
        <text x="200" y="200" font-size="16" font-family="Arial" text-anchor="middle" fill="black" font-weight="bold">
          知识付费墙
        </text>
      </g>

      <!-- 初始水位 -->
      <rect id="water" x="150" y="250" width="100" height="0" fill="#A3DFFA" opacity="0.8">
        <animate id="waterRise" attributeName="y" dur="0.5s" fill="freeze" begin="indefinite" />
        <animate id="waterHeight" attributeName="height" dur="0.5s" fill="freeze" begin="indefinite" />
      </rect>

      <!-- 水面波纹效果 -->
      <path
        id="waterWave"
        d="M150,250 Q175,248 200,250 Q225,252 250,250"
        stroke="#7AC5E4"
        fill="none"
        opacity="0"
        stroke-width="1.5"
      >
        <animate attributeName="opacity" values="0;0.7;0" dur="1.5s" begin="waterRise.begin" />
        <animate
          attributeName="d"
          values="M150,250 Q175,248 200,250 Q225,252 250,250;M150,250 Q175,252 200,250 Q225,248 250,250;M150,250 Q175,248 200,250 Q225,252 250,250"
          dur="1.5s"
          begin="waterRise.begin"
        />
      </path>

      <!-- 石子组 -->
      <g id="stones"></g>

      <!-- 乌鸦 -->
      <g id="crow">
        <!-- 身体 -->
        <ellipse cx="50" cy="50" rx="25" ry="12" fill="#1C2526" />

        <!-- 头部 -->
        <circle cx="75" cy="45" r="8" fill="#1C2526">
          <animateTransform
            attributeName="transform"
            type="rotate"
            values="0 75 45; 5 75 45; -5 75 45; 0 75 45"
            dur="2s"
            repeatCount="indefinite"
          />
        </circle>

        <!-- 喙 -->
        <polygon points="83,45 90,50 83,55" fill="#F5C518">
          <animateTransform
            attributeName="transform"
            type="rotate"
            values="0 83 50; 5 83 50; -5 83 50; 0 83 50"
            dur="1.5s"
            repeatCount="indefinite"
          />
        </polygon>

        <!-- 乌鸦嘴边的石子 -->
        <circle id="birdStone" cx="88" cy="50" r="5" fill="gray" />

        <!-- 翅膀 - 左 -->
        <path d="M45,50 Q30,60 35,70 Q45,75 55,50" fill="#1C2526">
          <animateTransform
            attributeName="transform"
            type="rotate"
            values="0 50 50; -15 50 50; 0 50 50; 5 50 50; 0 50 50"
            dur="0.8s"
            repeatCount="indefinite"
          />
        </path>

        <!-- 翅膀 - 右 -->
        <path d="M45,50 Q30,45 35,40 Q45,35 55,50" fill="#1C2526">
          <animateTransform
            attributeName="transform"
            type="rotate"
            values="0 50 50; 5 50 50; 0 50 50; -15 50 50; 0 50 50"
            dur="0.8s"
            repeatCount="indefinite"
          />
        </path>

        <!-- 尾巴 -->
        <path d="M25,50 Q35,65 45,50" fill="#1C2526">
          <animateTransform
            attributeName="transform"
            type="rotate"
            values="0 25 50; 5 25 50; -5 25 50; 0 25 50"
            dur="2s"
            repeatCount="indefinite"
          />
        </path>

        <!-- 眼睛 -->
        <circle cx="77" cy="43" r="2" fill="white">
          <animate id="eyeBlink" attributeName="r" values="2;0.5;2" dur="0.3s" begin="indefinite" repeatCount="1" />
        </circle>
        <circle cx="77" cy="43" r="0.8" fill="black" />

        <!-- 脚 -->
        <g id="legs">
          <!-- 左腿 -->
          <line x1="45" y1="60" x2="45" y2="75" stroke="#1C2526" stroke-width="1.5">
            <animateTransform
              attributeName="transform"
              type="rotate"
              values="0 45 60; 5 45 60; -5 45 60; 0 45 60"
              dur="1s"
              repeatCount="indefinite"
            />
          </line>
          <!-- 左脚爪 -->
          <line x1="45" y1="75" x2="42" y2="80" stroke="#1C2526" stroke-width="1" />
          <line x1="45" y1="75" x2="45" y2="80" stroke="#1C2526" stroke-width="1" />
          <line x1="45" y1="75" x2="48" y2="80" stroke="#1C2526" stroke-width="1" />

          <!-- 右腿 -->
          <line x1="55" y1="60" x2="55" y2="75" stroke="#1C2526" stroke-width="1.5">
            <animateTransform
              attributeName="transform"
              type="rotate"
              values="0 55 60; -5 55 60; 5 55 60; 0 55 60"
              dur="1.2s"
              repeatCount="indefinite"
            />
          </line>
          <!-- 右脚爪 -->
          <line x1="55" y1="75" x2="52" y2="80" stroke="#1C2526" stroke-width="1" />
          <line x1="55" y1="75" x2="55" y2="80" stroke="#1C2526" stroke-width="1" />
          <line x1="55" y1="75" x2="58" y2="80" stroke="#1C2526" stroke-width="1" />
        </g>

        <!-- 动画 -->
        <animateTransform
          id="crowMove"
          attributeName="transform"
          type="translate"
          from="0,0"
          to="100,40"
          dur="1.5s"
          begin="indefinite"
          fill="freeze"
        />
        <animateTransform
          id="crowDrink"
          attributeName="transform"
          type="rotate"
          from="0 75 45"
          to="-20 75 45"
          dur="0.5s"
          begin="indefinite"
          fill="freeze"
        />
        <animateTransform
          id="crowReturn"
          attributeName="transform"
          type="translate"
          from="100,40"
          to="0,0"
          dur="1.5s"
          begin="indefinite"
          fill="freeze"
        />
      </g>
    </svg>
    <audio id="stoneSplash" src="https://www.soundjay.com/buttons/beep-01a.mp3"></audio>
    <audio id="crowCaw" src="https://www.soundjay.com/nature/crow-01.mp3"></audio>

    <script>
      const Engine = Matter.Engine,
        World = Matter.World,
        Bodies = Matter.Bodies;

      const engine = Engine.create();
      const world = engine.world;
      engine.world.gravity.y = 0.5;

      const ground = Bodies.rectangle(200, 252, 100, 5, { isStatic: true });
      const leftWall = Bodies.rectangle(150, 200, 10, 100, { isStatic: true });
      const rightWall = Bodies.rectangle(250, 200, 10, 100, { isStatic: true });
      World.add(world, [ground, leftWall, rightWall]);

      const stonesGroup = document.getElementById("stones");
      const crow = document.getElementById("crow");
      const water = document.getElementById("water");
      const waterRise = document.getElementById("waterRise");
      const waterHeightAnim = document.getElementById("waterHeight");
      const crowMove = document.getElementById("crowMove");
      const crowDrink = document.getElementById("crowDrink");
      const crowReturn = document.getElementById("crowReturn");
      const stoneSplash = document.getElementById("stoneSplash");
      const crowCaw = document.getElementById("crowCaw");
      const birdStone = document.getElementById("birdStone");
      const eyeBlink = document.getElementById("eyeBlink");

      let waterLevel = 250;
      let waterHeight = 0;
      let stoneCount = 0;
      const maxStones = 50;
      let isAnimationInProgress = false;

      document.getElementById("dropStone").addEventListener("click", () => {
        if (stoneCount >= maxStones) {
          alert("水位已足够，乌鸦可以喝水了！");
          eyeBlink.beginElement();
          crowDrink.beginElement();
          crowCaw.play();
          return;
        }

        // 防止重复点击
        if (isAnimationInProgress) {
          return;
        }
        isAnimationInProgress = true;

        // 触发眨眼动画
        eyeBlink.beginElement();

        // 乌鸦飞向水桶
        crowMove.beginElement();

        crowMove.addEventListener(
          "endEvent",
          () => {
            console.log("Crow moved to water tank, dropping stone...");
            // 隐藏乌鸦嘴边的石子
            birdStone.setAttribute("opacity", "0");

            // 再次眨眼
            eyeBlink.beginElement();

            const stone = Bodies.circle(180, 100, 5, {
              restitution: 0.3,
              friction: 0.5,
              density: 0.01,
            });
            stone.isStopped = false;
            World.add(world, stone);

            const svgStone = document.createElementNS("http://www.w3.org/2000/svg", "circle");
            svgStone.setAttribute("cx", 180);
            svgStone.setAttribute("cy", 100);
            svgStone.setAttribute("r", 5);
            svgStone.setAttribute("fill", "gray");
            stonesGroup.appendChild(svgStone);

            stone.svgElement = svgStone;
            stoneCount++;

            // 检查石子是否停止的间隔
            let stoneDropped = false;
            let checkStoneInterval = setInterval(() => {
              if (stone.speed < 0.14 && Math.floor(stone.position.y) >= 244 && !stoneDropped) {
                console.log("Stone stopped at y:", stone.position.y);
                stoneDropped = true;
                clearInterval(checkStoneInterval);

                // 更新水位
                waterLevel -= 0.5;
                waterHeight += 0.5;
                if (waterLevel < 150) waterLevel = 150;
                if (waterHeight > 100) waterHeight = 100;
                waterRise.setAttribute("from", water.getAttribute("y"));
                waterRise.setAttribute("to", waterLevel);
                waterHeightAnim.setAttribute("from", water.getAttribute("height"));
                waterHeightAnim.setAttribute("to", waterHeight);
                waterRise.beginElement();
                waterHeightAnim.beginElement();
                water.setAttribute("y", waterLevel);
                water.setAttribute("height", waterHeight);
                stoneSplash.play();

                // 乌鸦返回初始位置
                setTimeout(() => {
                  eyeBlink.beginElement();
                  crowReturn.beginElement();
                  crowReturn.addEventListener(
                    "endEvent",
                    () => {
                      // 显示乌鸦嘴边的石子
                      birdStone.setAttribute("opacity", "1");
                      isAnimationInProgress = false;
                    },
                    { once: true },
                  );
                }, 1500);
              }
            }, 100);
          },
          { once: true },
        );
      });

      document.getElementById("reset").addEventListener("click", () => {
        console.log("Resetting...");
        world.bodies.forEach((body) => {
          if (body.svgElement) {
            stonesGroup.removeChild(body.svgElement);
            World.remove(world, body);
          }
        });
        waterLevel = 250;
        waterHeight = 0;
        water.setAttribute("y", waterLevel);
        water.setAttribute("height", waterHeight);
        crow.setAttribute("transform", "translate(0, 0)");
        crow.removeAttribute("style");
        // 重置时显示乌鸦嘴边的石子
        birdStone.setAttribute("opacity", "1");
        stoneCount = 0;
        isAnimationInProgress = false;
        console.log("Reset complete, crow transform:", crow.getAttribute("transform"));
      });

      (function run() {
        Engine.update(engine);
        world.bodies.forEach((body) => {
          if (body.svgElement) {
            body.svgElement.setAttribute("cx", body.position.x);
            body.svgElement.setAttribute("cy", body.position.y);
          }
        });
        requestAnimationFrame(run);
      })();
    </script>
  </body>
</html>
